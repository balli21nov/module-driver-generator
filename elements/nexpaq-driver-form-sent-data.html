<!-- Load the Polymer.Element base class -->
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/app-localize-behavior/app-localize-behavior.html">

<dom-module id="nexpaq-driver-form-sent-data">
  <template>
  	<style>

      :host {
        display: block;
        box-sizing: border-box;
        padding: 10px;
        position: relative;
        overflow: auto;
      }
      paper-tooltip {
        --paper-tooltip-opacity: 0.8;
        --paper-tooltip-background: black ;
        --paper-tooltip-text-color: white;
        width: 120px;
        font-size: 13px;
      }
      paper-button.indigo {
        color: white;
        background-color: #606060;
        float: right;
        font-size: 8px;
        width: 25%; height: 9%;
      }
      paper-button.indigo.mid {
        margin-top: 18px;
        clear: right;
        float: right;
        font-size: 9px;
        width: 28%; height: 11%;
      }
      paper-button.indigo.outer {
        margin-top: 25px;
        clear: right;
        float: right;
        font-size: 10px;
        width: 30%; height: 12%;
      }
      h4 {
        color: #606060;
        font-weight: 500;
        text-align: center;
        padding-top: 24px;
        display: block;
      }
      .container-left {
        float: left;
        width: 45%;
      }
      .container-right {
        float: right;
        width: 45%;
      }
      .clearfix {
        clear: right;
      }
      .subfield-container {
      	margin-left: 25px;
      }
      .wrapper {
        width:98%;
      }
      .close {
        float: right;
        width: 6px;
        right: 2px;
        /*top: -2px;*/
      }
      .close:hover {
        color: #EE3696;
      }
      paper-input {
      	--secondary-text-color: #9b9b9b;
      	--paper-font-subhead_-_font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      }
      span {
      	color: #9b9b9b;
      	font-size: 12px;
      	font-weight: 300;
      	font-family: Helvetica, Arial, sans-serif;
      	line-height: 24px;
      }
    </style>
    <h4>{{localize('sendingData')}}</h4>
    <paper-input always-float-label id="type"  label="{{localize('type')}}" value="{{sentData.type}}" required auto-validate allowed-pattern="[A-Za-z_\.\-0-9]" error-message="This field is required!" maxlength="50" on-change="validateForm"></paper-input>
    <paper-tooltip for="type" offset="-7" position="bottom">ex : nexpaq.module.led</paper-tooltip>

    <paper-input always-float-label id="version" label="{{localize('version')}}" value="{{sentData.version}}" required auto-validate allowed-pattern="[0-9_\.]" error-message="This field is required!" maxlength="20" on-change="validateForm"></paper-input>
    <paper-tooltip for="version" offset="-7" position="bottom">ex : 1.0.0</paper-tooltip>

    <span>{{localize('commands')}}</span>
    <div class="subfield-container">
      <template is="dom-repeat" items="{{sentData.commands}}" as="command" index-as="commandIndex">
        <div class = "wrapper clearfix">
          <span class="close" on-click = "removeCommand">&times;</span>
          <paper-input always-float-label id="name" class="clearfix" label="{{localize('name')}}" value="{{command.name}}" required auto-validate error-message="This field is required!" maxlength="50" on-change="validateForm"></paper-input>
          <paper-tooltip for="name" offset="-7" position="bottom">ex : SetRGB</paper-tooltip>
          <paper-input always-float-label id="title" label="{{localize('title')}}" value="{{command.title}}" required auto-validate error-message="This field is required!" maxlength="80" on-change="validateForm"></paper-input>
          <paper-tooltip for="title" offset="-7" position="bottom">ex : Set color in RGB</paper-tooltip>
          <paper-input always-float-label id="description" label="{{localize('description')}}" value="{{command.description}}" required auto-validate error-message="This field is required!" maxlength="150" on-change="validateForm"></paper-input>
          <paper-tooltip for="description" offset="-7" position="bottom">ex : Changes color of module to specified RGB color</paper-tooltip>
          <span>{{localize('arguments')}}</span>
          <div class="subfield-container">
            <template is="dom-repeat" items="{{command.arguments}}" as="argument" index-as="argumentIndex">
                <div class = "wrapper clearfix">
                  <span class="close" on-click = "removeArgument">&times;</span>
                  <paper-input class= "container-left" always-float-label id="name" label="{{localize('argumentName')}}" value="{{argument.name}}" auto-validate maxlength="50" on-change="validateForm"></paper-input>
                  <paper-tooltip for="name" offset="-7" position="bottom">ex : Red</paper-tooltip>
                  <paper-input class= "container-right" always-float-label id="validation" label="{{localize('validation')}}" value="{{argument.validation}}" auto-validate maxlength="50" on-change="validateForm"></paper-input>
                  <paper-tooltip for="validation" offset="-7" position="bottom">ex : ({0} >= 0) and ({0} <= 255)</paper-tooltip>
                </div>
            </template>
            <paper-button raised class="indigo clearfix" on-click="addMoreFields"> + {{localize('addMore')}} {{localize('fields')}}</paper-button>
          </div>
          <template is="dom-if" if="{{commandAdded}}">
            <div class = "wrapper clearfix">
              <span class="close" on-click = "toggleCommand">&times;</span>
              <paper-input class="clearfix" always-float-label id="command" label="{{localize('command')}}" value="{{command.command}}" required auto-validate error-message="This field is required!" maxlength="50" on-change="validateForm"></paper-input>
              <paper-tooltip for="command" offset="-7" position="bottom">ex : 2702</paper-tooltip>
            </div>
          </template>
          <template is="dom-if" if="{{!commandAdded}}">
            <paper-button raised class="indigo mid clearfix" on-click="toggleCommand"> + Add Command</paper-button>
          </template>
          <template is="dom-if" if="{{dataAdded}}">
            <div class = "wrapper clearfix">
            <span>{{localize('data')}}</span>
            <div class="subfield-container">
              <template is="dom-repeat" items="{{command.data}}" as="data" index-as="commandDataIndex">
                <div class = "wrapper clearfix">
                    <span class="close" on-click = "removeData">&times;</span>
                    <paper-input class="clearfix" always-float-label id="defaultValue" label="{{localize('defaultValue')}}" value="{{data.defaultValue}}" auto-validate allowed-pattern="[0-9]" maxlength="20" on-change="validateForm"></paper-input>
                    <paper-tooltip for="defaultValue" offset="-7" position="bottom">ex : 0</paper-tooltip>
                    <paper-input class= "container-left" always-float-label id="convert" label="{{localize('convert')}}" value="{{data.convert}}" auto-validate maxlength="50" on-change="validateForm"></paper-input>
                    <paper-tooltip for="convert" offset="-7" position="bottom">ex : true</paper-tooltip>
                    <paper-input class= "container-right" always-float-label id="format" label="{{localize('format')}}" value="{{data.format}}" auto-validate maxlength="50" on-change="validateForm"></paper-input>
                    <paper-tooltip for="format" offset="-7" position="bottom">ex : ({0} >> 8) & 0xFF</paper-tooltip>
                  </div>
                </template>
                <paper-button raised class="indigo clearfix" on-click="addMoreData"> + {{localize('addMore')}} {{localize('data')}}</paper-button>
              </div>
            </div>
          </template>
          <template is="dom-if" if="{{!dataAdded}}">
            <paper-button raised class="indigo clearfix mid" on-click="toggleData"> + Add Data</paper-button>
          </template>
        </div>
      </template>
      <paper-button raised class="indigo clearfix outer" on-click="addMoreCommands"> + {{localize('addMore')}} {{localize('commands')}}</paper-button>
    </div>
  </template>
  <script>
    class NexpaqDriverFormSentData extends Polymer.mixinBehaviors([Polymer.AppLocalizeBehavior], Polymer.Element){
      static get is() { return 'nexpaq-driver-form-sent-data' }
      static get properties() {
        return {
        	sentData: {
            type: Object,
            notify: true,
            reflectToAttribute: true,
            value: function() {
              return {
                commands: [{
                  arguments: [{}],
                  data: [{}]
                }]
              };
            }
          },
          commandAdded: {
            type: Boolean,
            notify: true,
            value: function() {
              return false;
            }
          },
          dataAdded: {
            type: Boolean,
            notify: true,
            value: function() {
              return false;
            }
          },
          valid: {
            type: Boolean,
            notify: true,
            value: function() {
              return false;
            }
          },
        }
      }

      /**
       * Validates the form by checking each
       * paper input field.
       * @param {object}
       */
      validateForm() {
        var paperInputs = Polymer.dom(this.root).querySelectorAll("paper-input");
        for (var i=0; i<paperInputs.length; i++) {
          if (!this.validateField(paperInputs[i])) {
            this.valid = false;
            return;
          }
        }
        this.valid = true;
        return;
      }

      /**
       * Checks if the field is valid and required
       * field is filled.
       * @param {object}
       */
      validateField(field) {
        if(field.invalid) return false;
        if(field.required) {
          if (field.value == null || field.value == "") return false;
        }
        return true;
      }

      toArray(obj) {
         return Object.keys(obj).map(function(key) {
           return {
             stateKey: key,
             value: obj[key]
           };
         });
       }

       addMoreFields(e) {
        var i = e.model.commandIndex;
         var item = 'sentData.commands.'+i+'.arguments';
         this.push(item, {});
       }

       removeArgument(e) {
         var i = e.model.parentModel.commandIndex;
         var item = 'sentData.commands.'+i+'.arguments';
         var index = e.model.argumentIndex;
         this.splice(item, index, 1);
       }

       toggleCommand() {
        if(this.commandAdded) {
          this.commandAdded = false;
        } else {
          this.commandAdded = true;
        }
       }

       toggleData() {
         if(this.dataAdded) {
           this.dataAdded = false;
         } else {
           this.dataAdded = true;
         }
       }

       addMoreData(e) {
         var i = e.model.commandIndex;
         var item = 'sentData.commands.'+i+'.data';
         this.push(item, {});
       }

       removeData(e) {
         if(e.model.itemsIndex == 0) {
           this.toggleData();
         }
         var i = e.model.parentModel.commandIndex;
         var item = 'sentData.commands.'+i+'.data';
         var index = e.model.commandDataIndex;
         this.splice(item, index, 1);
       }

       addMoreCommands(e) {
         var item = 'sentData.commands';
         this.push(item, {
           arguments: [{}],
           data: [{}]
         });
       }

       removeCommand(e) {
         var item = 'sentData.commands';
         var index = e.model.commandIndex;
         this.splice(item, index, 1);

       }

       addMoreState(e) {
         var i = e.model.dataIndex;
         var j = e.model.variableIndex;
         var item = 'receivedData.data.'+i+'.variables'+j+'.state';
         //Since state is object push doesnt work
         //this.set(item, {} );
       }
    }
    customElements.define(NexpaqDriverFormSentData.is, NexpaqDriverFormSentData);
  </script>
</dom-module>
