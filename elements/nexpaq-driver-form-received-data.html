<!-- Load the Polymer.Element base class -->
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../mixins/nexpaq-driver-common-functions.html">
<link rel="import" href="../styles/nexpaq-driver-form-common-styles.html">
<link rel="import" href="nexpaq-driver-form-states.html">
<link rel="import" href="nexpaq-driver-form-variables.html">

<dom-module id="nexpaq-driver-form-received-data">
  <template>
  	<style include="nexpaq-driver-form-common-styles">

      :host {
        display: block;
        box-sizing: border-box;
        padding: 0 10px 10px 10px;
        position: relative;
        overflow: auto;
      }

    </style>
    <template is="dom-if" if="{{receivedDataAdded}}">
      <h4 class="header">{{localize('receivingData')}}</h4>
    	<span class="field">{{localize('data')}}</span>
      <div class="subfield-container">
  	  	<template is="dom-repeat" items="{{receivedData.data}}" as="dataInReceived" index-as="dataIndex">
          <span class="close" on-click = "removeReceivedData">&times;</span>
  	  		<paper-input always-float-label id="name" label="{{localize('name')}}" value="{{dataInReceived.name}}" required auto-validate error-message="This field is required!" maxlength="50" on-change="validateForm"></paper-input>
  	      <paper-tooltip for="name" offset="-7" position="bottom">ex : SensorValue</paper-tooltip>
  	      <paper-input always-float-label id="title" label="{{localize('title')}}" value="{{dataInReceived.title}}" required auto-validate error-message="This field is required!" maxlength="50" on-change="validateForm"></paper-input>
  	      <paper-tooltip for="title" offset="-7" position="bottom">ex : Sensor value</paper-tooltip>
  	      <paper-input always-float-label id="description" label="{{localize('description')}}" value="{{dataInReceived.description}}" required auto-validate error-message="This field is required!" maxlength="150" on-change="validateForm"></paper-input>
  	      <paper-tooltip for="description" offset="-7" position="bottom">ex : Value from Temperature and Humidity sensor</paper-tooltip>
  	      <paper-input always-float-label id="source" label="{{localize('source')}}" value="{{dataInReceived.source}}" required auto-validate error-message="This field is required!" maxlength="50" on-change="validateForm"></paper-input>
  	      <paper-tooltip for="source" offset="-7" position="bottom">ex : 2800</paper-tooltip>
          <template is="dom-if" if="{{variableAdded}}">
            <span class="field">{{localize('variable')}}</span>
            <nexpaq-driver-form-variables added="{{variableAdded}}" language="[[language]]" resources="[[resources]]" variables="{{dataInReceived.variables}}" received-data="{{receivedData}}" data-index="[[dataIndex]]" valid="{{valid}}"></nexpaq-driver-form-variables>
          </template>
          <template is="dom-if" if="{{!variableAdded}}">
            <paper-button raised class="indigo mid" on-click="toggleVariable"> + Add Variable</paper-button>
          </template>
  		  </template>
        <paper-button raised class="indigo main outer" on-click="addMoreReceivedData"> + {{localize('add')}} {{localize('data')}}</paper-button>
      </div>
    </template>
    <template is="dom-if" if="{{!receivedDataAdded}}">
      <paper-button raised class="indigo main" on-click="toggleData"> + Add Data</paper-button>
    </template>
  </template>
  <script>
    class NexpaqDriverFormReceivedData extends Polymer.mixinBehaviors([Polymer.AppLocalizeBehavior], NexpaqDriverCommonFunctions(Polymer.Element)){
      static get is() { return 'nexpaq-driver-form-received-data' }
      static get properties() {
        return {
          receivedData: {
            type: Object,
            notify: true,
            value: function() {
              return {
              };
            }
          },
          receivedDataAdded: {
            type: Boolean,
            notify: true,
            value: function() {
              return false;
            }
          },
          variableAdded: {
            type: Boolean,
            notify: true,
            value: function() {
              return false;
            }
          },
          formatAdded: {
            type: Boolean,
            notify: true,
            value: function() {
              return true;
            }
          },
          valid: {
            type: Boolean,
            notify: true,
            value: function() {
              return true;
            }
          }
        }
      }


      toggleVariable(e) {
        if(this.variableAdded) {
          this.variableAdded = false;
        } else {
          this.variableAdded = true;
          var i = e.model.dataIndex;
          var item = 'receivedData.data.'+i+'.variables';
          this.set(item, [{state: {'key1':''}}]);
        }
      }

      addMoreReceivedData(e) {
        var item = 'receivedData.data';
        this.push(item, {})
      }

      removeReceivedData(e) {
        if(this.receivedData.data.length == 1) {
          delete this.receivedData['data'];
          this.notifyPath('receivedData.data');
          this.toggleData();
        } else {
          var item = 'receivedData.data';
          var index = e.model.dataIndex;
          this.splice(item, index, 1);
        }
      }

      toggleData() {
        if(this.receivedDataAdded) {
          this.receivedDataAdded = false;
        } else {
          this.receivedDataAdded = true;
          var item = 'receivedData.data';
          this.set(item,[{}]);
        }
      }
    }
    customElements.define(NexpaqDriverFormReceivedData.is, NexpaqDriverFormReceivedData);
  </script>
</dom-module>
